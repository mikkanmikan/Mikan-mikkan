<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Study Gacha Timer</title>
<style>
body { margin:0; font-family:sans-serif; background:#111; color:white; }
.screen { display:none; height:100vh; padding:20px; box-sizing:border-box; }

#startScreen { display:block; }
#timerScreen, #resultScreen { text-align:center; }

.topGacha {
  height:60%;
  border:2px solid #444;
  padding:10px;
}
.bottomStart {
  height:40%;
  display:flex;
  justify-content:center;
  align-items:center;
}

button { padding:10px 20px; font-size:16px; cursor:pointer; }
.smallBtn { font-size:12px; position:fixed; bottom:10px; right:10px; }

#gachaCount { position:fixed; top:10px; right:10px; font-size:16px; }

.rainbowBg {
  background: linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet);
}

.rainbowText {
  font-size:50px;
  font-weight:bold;
  background: linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet);
  -webkit-background-clip:text;
  color:transparent;
}

#resultBox {
  background:#222;
  padding:40px;
  border:3px solid white;
  display:inline-block;
  position:relative;
}

#closeResult {
  position:absolute;
  top:5px;
  right:5px;
  font-size:20px;
  cursor:pointer;
}

#lockTimer {
  font-size:30px;
  margin-top:20px;
}
</style>
</head>

<body>

<div id="gachaCount">Gacha: 0</div>
<button class="smallBtn" id="probBtn">確率</button>

<!-- スタート画面 -->
<div id="startScreen" class="screen">
  <div class="topGacha">
    <h2>ガチャエリア</h2>
    <button id="rollBtn">ガチャを回す</button>
    <div id="log"></div>
  </div>
  <div class="bottomStart">
    <button id="startBtn">タイマースタート</button>
  </div>
</div>

<!-- タイマー画面 -->
<div id="timerScreen" class="screen">
  <h1 id="timerDisplay">05:00</h1>
</div>

<!-- ガチャ結果画面 -->
<div id="resultScreen" class="screen">
  <div id="resultBox">
    <div id="closeResult">×</div>
    <div id="rarityText" class="rainbowText">N</div>
    <p id="resultMsg"></p>
    <div id="lockTimer"></div>
  </div>
</div>

<script>
// ================= 状態管理 =================
let state = "IDLE"; // IDLE, FOCUS, RESULT, LOCK
let firstSession = true;
let timerInterval, lockInterval;
let gachaCount = 0;

// ================= ガチャ確率 + 新メッセージ =================
const gachaTable = [
  {
    name:"Lucky",
    p:0.001,
    lock:60,
    msg:"スーパーレア！1000回に1回の奇跡だ！今日の集中力は限界突破。1時間しっかり休憩して脳を再起動しよう。"
  },
  {
    name:"UR",
    p:0.02,
    lock:20,
    msg:"よくやった。努力が結果になったな。20分休憩して次の学習に備えよう。休憩は戦略だ。"
  },
  {
    name:"SR",
    p:0.18,
    lock:10,
    msg:"お疲れ様。十分集中できている。10分休憩で脳をリフレッシュしよう。"
  },
  {
    name:"R",
    p:0.35,
    lock:5,
    msg:"おつかれさま。継続は力だ。5分だけ休憩してすぐ戻ろう。"
  },
  {
    name:"N",
    p:0.449,
    lock:5,
    msg:"おつかれ！ペースは悪くない。5分休憩してリズムを上げよう。次はレアを狙える。"
  }
];

// ================= 画面切替 =================
function show(screen){
  document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
  document.getElementById(screen).style.display="block";
}

// ================= タイマー =================
function startTimer(minutes){
  state="FOCUS";
  show("timerScreen");
  let time = minutes*60;
  updateTimer(time);
  timerInterval = setInterval(()=>{
    time--;
    updateTimer(time);
    if(time<=0){
      clearInterval(timerInterval);
      endSession();
    }
  },1000);
}

function updateTimer(t){
  let m = String(Math.floor(t/60)).padStart(2,"0");
  let s = String(t%60).padStart(2,"0");
  document.getElementById("timerDisplay").textContent = `${m}:${s}`;
}

// ================= セッション終了 =================
function endSession(){
  gachaCount++;
  updateGachaCount();
  document.body.classList.add("rainbowBg");
  show("startScreen");
  state="IDLE";
}

// ================= ガチャ =================
function rollGacha(){
  if(gachaCount<=0 || state!=="IDLE") return;
  gachaCount--;
  updateGachaCount();

  let r = Math.random();
  let sum = 0;
  let result;
  for(let g of gachaTable){
    sum += g.p;
    if(r < sum){ result=g; break; }
  }
  showResult(result);
}

// ================= ガチャ結果表示 =================
function showResult(result){
  state="RESULT";
  show("resultScreen");
  document.getElementById("rarityText").textContent = result.name;
  document.getElementById("resultMsg").textContent = result.msg;
  startLock(result.lock);
}

// ================= ロック =================
function startLock(minutes){
  let t = minutes*60;
  document.getElementById("lockTimer").textContent = `ロック: ${minutes}:00`;
  lockInterval = setInterval(()=>{
    t--;
    let m = String(Math.floor(t/60)).padStart(2,"0");
    let s = String(t%60).padStart(2,"0");
    document.getElementById("lockTimer").textContent = `ロック: ${m}:${s}`;
    if(t<=0){
      clearInterval(lockInterval);
      state="IDLE";
      show("startScreen");
    }
  },1000);
}

// ================= UI更新 =================
function updateGachaCount(){
  document.getElementById("gachaCount").textContent = "Gacha: " + gachaCount;
}

// ================= 確率表示 =================
document.getElementById("probBtn").onclick = ()=>{
  alert("ラッキーデー！...0.1%\nUR...2%\nSR...18%\nR...35%\nN...44.9%");
};

// ================= ボタン =================
document.getElementById("startBtn").onclick = ()=>{
  if(state!=="IDLE") return;
  let min = firstSession ? 5 : 25;
  firstSession=false;
  startTimer(min);
};

document.getElementById("rollBtn").onclick = rollGacha;

document.getElementById("closeResult").onclick = ()=>{
  show("startScreen");
};

// ================= 初期 =================
updateGachaCount();
</script>

</body>
</html>
